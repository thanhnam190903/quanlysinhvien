<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="admin/layout/head :: head"></head>
<body>
<div th:replace="admin/layout/header :: header"></div>
<div class="container-fluid p-0">
    <div class="row m-0">
        <div th:replace="admin/layout/navbar :: navbar"></div>
        <div class="col-md-9 col-lg-9 main-content">
            <div class="content-header">
                <h2>Danh sách sinh viên</h2>
            </div>

            <div class="search-container">
                <form method="get" th:action="@{/quantri/students}">
                    <input type="text" name="keyword" class="search-input" placeholder="Tìm kiếm theo ID hoặc tên..." value="${keyword != null ? keyword : ''}" th:value="${keyword}">
                    <button class="btn-search" type="submit">Tìm</button>
                </form>
                <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">Thêm mới</a>
                <a href="#"
                   class="btn btn-success" data-bs-toggle="modal"
                   data-bs-target="#uploadModal">Thêm nhiều</a>
            </div>

            <div class="table-container">
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    <strong>Thành công!</strong> <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-circle me-2"></i>
                    <strong>Lỗi!</strong> <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${successMessage}" class="alert alert-success">
                    <span th:text="${successMessage}"></span>
                </div>
                <table class="table">
                    <thead>
                    <tr>
                        <th>STT</th>
                        <th>Mã SV</th>
                        <th>Tên</th>
                        <th>Email</th>
                        <th>Địa chỉ</th>
                        <th>Ngày sinh</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="s,iterStat : ${studentList}">
                        <td th:text="${iterStat.index + 1}"></td>
                        <td th:text="${s.id}"></td>
                        <td th:text="${s.name}"></td>
                        <td th:text="${s.email}"></td>
                        <td th:text="${s.address}"></td>
                        <td th:text="${s.dateOfBirth != null} ? ${#temporals.format(s.dateOfBirth, 'dd/MM/yyyy')} : ''"></td>
                        <td th:if="${s.status}" style="color: red; font-weight: bold;">Tạm dừng</td>
                        <td th:if="${!s.status}" style="color: green; font-weight: bold;">Hoạt động</td>

                        <td>
                            <div class="action-icons">
                                <div class="action-icons">
                                    <a href="" class="text-success" data-bs-toggle="modal"
                                       data-bs-target="#updateUserModal">
                                    </a>
                                    <a
                                            class="btn-edit"
                                            th:data-id="${s.id}"
                                            th:data-fullname="${s.name}"
                                            th:data-email="${s.email}"
                                            th:data-sdt="${s.phone}"
                                            th:data-diachi="${s.address}"
                                            th:data-ngaysinh="${s.dateOfBirth}"><i
                                            class="fa-regular fa-pen-to-square text-success"></i></a>
                                    <a th:if="${!s.status}" class="text-success" th:data-id="${s.id}" onclick="confirmLock(this)">
                                        <i class="fa-solid fa-lock-open"></i>
                                    </a>
                                    <a th:if="${s.status}" class="text-danger" th:data-id="${s.id}" onclick="confirmUnlock(this)">
                                        <i class="fa-solid fa-lock"></i>
                                    </a>
                                    <a href="#" th:data-id="${s.id}" onclick="confirmreset(this)" class="text-success"><i class="fa-solid fa-rotate-left"></i></a>
                                    <a href="#" th:data-id="${s.id}" onclick="confirmDelete(this)" class="text-danger"><i class="fa-solid fa-trash"></i></a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div th:replace="~{admin/layout/pagination :: pagination(pageData=${studentList}, baseUrl='/quantri/students', keyword=${keyword})}"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1"
     aria-labelledby="addUserModalLabel" aria-hidden="true" th:classappend="${showModal} ? 'show d-block' : ''">
    <div class="modal-dialog modal-md"><!-- nhỏ hơn modal-lg -->
        <div class="modal-content">
            <div class="modal-header btn-search">
                <h5 class="modal-title" id="addUserModalLabel">Thêm mới sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <!-- Form thêm người dùng -->
                <form id="addUserForm" th:action="@{/quantri/add-student}" th:object="${student}" method="post">
                    <div class="g-2">
                        <div class="col-12 mb-2">
                            <label class="form-label">Mã</label>
                            <input type="text" th:field="*{id}" class="form-control" name="id" required>
                        </div>
                        <div class="col-12 mb-2">
                            <label class="form-label">Tên</label>
                            <input type="text" th:field="*{name}" class="form-control" name="ten" required>
                        </div>
                        <div class="col-12 mb-2">
                            <label class="form-label">Địa chỉ</label>
                            <input type="text" th:field="*{address}" class="form-control" name="address" required>
                        </div>
                        <div class="col-12 mb-2">
                            <label class="form-label">SDT</label>
                            <input type="text" th:field="*{phone}" class="form-control" pattern="^0\d{9}$"
                                   title="Số điện thoại phải bắt đầu bằng 0 và có 10 chữ số." name="sdt" required>
                        </div>
                        <div class="col-12 mb-2">
                            <label class="form-label">Email</label>
                            <input type="email" th:field="*{email}" class="form-control" name="email" required>
                        </div>
                        <div class="col-12 mb-2">
                            <label class="form-label">Ngày sinh</label>
                            <input type="date" th:field="*{dateOfBirth}" class="form-control" name="ngaysinh" required>
                        </div>
                    </div>

                    <!-- Nút căn giữa -->
                    <div class="d-flex mt-3 gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">Thêm mới</button>
                        <a type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Thoát</a>
                    </div>
                </form>
                <div id="alertMessage" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateUserModal" tabindex="-1"
     aria-labelledby="updateUserModalLabel" aria-hidden="true" th:classappend="${showModal} ? 'show d-block' : ''">
    <div class="modal-dialog modal-md"><!-- nhỏ hơn modal-lg -->
        <div class="modal-content">
            <div class="modal-header btn-search">
                <h5 class="modal-title" id="updateUserModalLabel">Thay đổi thông tin sinh viên</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <!-- Form thêm người dùng -->
                <form id="updateUserForm" th:action="@{/quantri/update-student}" method="post">
                    <div class="col-12 mb-2">
                        <label class="form-label">Mã</label>
                        <input type="text" class="form-control" id="edit-id" name="id" required>
                    </div>
                    <div class="col-12 mb-2">
                        <label class="form-label">Tên</label>
                        <input type="text" class="form-control" id="edit-fullname" name="name" required>
                    </div>
                    <div class="col-12 mb-2">
                        <label class="form-label">Địa chỉ</label>
                        <input type="text" class="form-control" id="edit-diachi" name="address" required>
                    </div>
                    <div class="col-12 mb-2">
                        <label class="form-label">Số điện thoại</label>
                        <input type="text" class="form-control" pattern="^0\d{9}$" title="Số điện thoại phải bắt đầu bằng 0 và có 10 chữ số." id="edit-sdt" name="phone" required>
                    </div>
                    <div class="col-12 mb-2">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="edit-email" name="email" required>
                    </div>
                    <div class="col-12 mb-2">
                        <label class="form-label">Ngày sinh</label>
                        <input type="date" class="form-control" id="edit-ngaysinh" name="dateOfBirth" required>
                    </div>

                    <div class="d-flex mt-3 gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">Cập nhật</button>
                        <button type="button" class="btn btn-secondary flex-fill" data-bs-dismiss="modal">Hủy</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!--<div class="modal fade" id="importModal" tabindex="-1">-->
<!--    <div class="modal-dialog modal-dialog-centered">-->
<!--        <div class="modal-content">-->

<!--            &lt;!&ndash; Header &ndash;&gt;-->
<!--            <div class="modal-header text-white" style="background-color: #2e5da1;">-->
<!--                <h5 class="modal-title">Import dữ liệu</h5>-->
<!--                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>-->
<!--            </div>-->

<!--            &lt;!&ndash; Body &ndash;&gt;-->
<!--            <div class="modal-body">-->
<!--                <form id="uploadForm" style="margin-left: 71px;">-->

<!--                    <label for="fileInput" class="upload-box">-->
<!--                        <div class="upload-icon">-->
<!--                            <i class="bi bi-file-earmark-arrow-up"></i>-->
<!--                        </div>-->
<!--                        <div>-->
<!--                            <b>Kéo thả file vào đây</b> hoặc-->
<!--                            <span class="text-primary">chọn file</span>-->
<!--                        </div>-->
<!--                        <small class="text-muted">-->
<!--                            Hỗ trợ: .xlsx, .xls, .csv (Tối đa 10MB)-->
<!--                        </small>-->
<!--                        <input type="file" id="fileInput" hidden accept=".xls,.xlsx,.csv">-->
<!--                    </label>-->

<!--                </form>-->
<!--            </div>-->

<!--            &lt;!&ndash; Footer &ndash;&gt;-->
<!--            <div class="modal-footer">-->
<!--                <button class="btn btn-light" data-bs-dismiss="modal">Hủy</button>-->
<!--                <button class="btn btn-primary" onclick="uploadFile()">Upload</button>-->
<!--            </div>-->

<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header text-white" style="background-color: #2e5da1;">
                <h5 class="modal-title">Import dữ liệu từ Excel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <form id="importForm" th:action="@{/quantri/import_student}" style="text-align: center;" method="POST" enctype="multipart/form-data">
                    <label for="fileInput" class="upload-box" id="uploadBox">
                        <div class="upload-icon">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </div>
                        <div>
                            <b>Kéo thả file vào đây</b> hoặc<br>
                            <span class="text-primary">chọn file</span>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Hỗ trợ: .xlsx, .xls, .csv (Tối đa 10MB)
                        </small>
                        <div class="file-name" id="fileName"></div>
                        <input type="file" id="fileInput" name="file" hidden accept=".xls,.xlsx,.csv">
                    </label>
                </form>

                <!-- Hướng dẫn format file -->
                <div class="alert alert-info mt-3 mb-0">
                    <strong>Định dạng file Excel:</strong>
                    <ul class="mb-0 mt-2" style="font-size: 13px;">
                        <li>Cột 1: ID (bắt buộc)</li>
                        <li>Cột 2: Tên (bắt buộc)</li>
                        <li>Cột 3: Email</li>
                        <li>Cột 4: Điện thoại</li>
                        <li>Cột 5: Địa chỉ</li>
                        <li>Cột 6: Ngày sinh (dd/MM/yyyy)</li>
                    </ul>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
                <button type="submit" form="importForm" class="btn btn-primary" id="uploadBtn" disabled>
                    <i class="bi bi-upload me-2"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Bootstrap Bundle JS (đã bao gồm Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function confirmDelete(element) {
    const userId = element.dataset.id;
    if (confirm("Bạn có chắc chắn muốn xóa sinh viên " + userId + " này?")) {
        window.location.href = "/qlsv/quantri/delete-student?id=" + userId;
    }
}
function confirmLock(element) {
    const userId = element.dataset.id;
        if (confirm("Bạn có chắc chắn muốn khóa tài khoản " + userId
                + " này?")) {
            window.location.href = "/qlsv/quantri/lock-user?id=" + userId;
        }
    }

    function confirmreset(element) {
    const userId = element.dataset.id;
        if (confirm("Bạn có chắc chắn muốn reset mật khẩu " + userId
                + " này?")) {
            window.location.href = "/qlsv/quantri/reset-pass?id=" + userId;
        }
    }
    function confirmUnlock(element) {
    const userId = element.dataset.id;
        if (confirm("Bạn có chắc chắn muốn mở khóa tài khoản " + userId
                + " này?")) {
            // Nếu người dùng xác nhận, chuyển đến trang mở khóa
            window.location.href = "/qlsv/quantri/unlock-user?id=" + userId;
        }
    }

    document.querySelectorAll(".btn-edit").forEach(btn => {
    btn.addEventListener("click", function () {
        document.getElementById("edit-id").value = this.dataset.id;
        document.getElementById("edit-fullname").value = this.dataset.fullname;
        document.getElementById("edit-email").value = this.dataset.email;
        document.getElementById("edit-sdt").value = this.dataset.sdt;
        document.getElementById("edit-diachi").value = this.dataset.diachi;
        document.getElementById("edit-ngaysinh").value = this.dataset.ngaysinh;

        new bootstrap.Modal(document.getElementById('updateUserModal')).show();
    });
});

    const fileInput = document.getElementById('fileInput');
const uploadBox = document.getElementById('uploadBox');
const fileName = document.getElementById('fileName');
const uploadBtn = document.getElementById('uploadBtn');

// Drag & Drop
uploadBox.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadBox.classList.add('dragover');
});

uploadBox.addEventListener('dragleave', () => {
    uploadBox.classList.remove('dragover');
});

uploadBox.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadBox.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect();
    }
});

// File Input Change
fileInput.addEventListener('change', handleFileSelect);

function handleFileSelect() {
    const file = fileInput.files[0];
    if (file) {
        fileName.textContent = '✓ ' + file.name;
        uploadBtn.disabled = false;
    }
}
</script>
</body>
</html>